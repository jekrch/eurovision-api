services:
  # 1. API
  api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${API_PORT}:8080" 
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      # .NET automatically maps double underscores (__) to configuration hierarchy (Jwt:Key)
      - Jwt__Key=${JWT_SECRET} 
      # Construct connection string dynamically using .env values
      - ConnectionStrings__DefaultConnection=Server=db;Port=5432;Database=${DB_NAME};User Id=${DB_USER};Password=${DB_PASSWORD};SearchPath=ranker
    depends_on:
      - db
      - flyway

  # 2. Database (Local)
  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    ports:
      - "${DB_PORT}:5432" 
    volumes:
      - local_pg_data:/var/lib/postgresql/data

  # 3. Migrations
  flyway:
    image: flyway/flyway:latest
    command: -connectRetries=60 migrate
    volumes:
      - ./EurovisionRanker.Api/db/migration:/flyway/sql 
    environment:
      # Flyway uses JDBC syntax
      - FLYWAY_URL=jdbc:postgresql://db:5432/${DB_NAME}
      - FLYWAY_USER=${DB_USER}
      - FLYWAY_PASSWORD=${DB_PASSWORD}
    depends_on:
      - db

volumes:
  local_pg_data: